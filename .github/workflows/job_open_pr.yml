name: ":: open a PR"

on:
  workflow_call:
    secrets:
      PR_PAT:
        required: true
    inputs:
      release-version:
        required: true
        type: string

jobs:
  create-pull-request:
    name: "⛴️  Preapare changes"
    runs-on: macos-14
    permissions:
      id-token: write

    steps:
      - name: "♻️ Checkout"
        uses: actions/checkout@v4

      - name: "🛬  Add new XCFramework"
        uses: actions/download-artifact@v4
        with:
          name: XCFramework
          path: Framework
          repository: ${{ github.repository }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: "🛬  Add changelog"
        uses: actions/download-artifact@v4
        with:
          name: Changelog
          repository: ${{ github.repository }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: "🔏  Setup git sign"
        uses: chainguard-dev/actions/setup-gitsign@main

      - name: "🍾  Open a PR"
        id: open-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: "${{ secrets.PR_PAT }}"
          branch: release/candidate
          delete-branch: true
          base: main
          title: "[RELEASE] ${{ inputs.release-version }}"
          commit-message: "Automated change: Updated version of XCFramework."
          draft: true

      - name: "🏷️  Tag the PR commit"
        if: ${{ steps.open-pr.outputs.pull-request-number }}
        uses: CrabMatrix/github-tagger@v1.0.16
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          tag: "${{ inputs.release-version }}"
          commit-sha: ${{ steps.open-pr.outputs.pull-request-head-sha }}
