name: "Release new version"

on:
  workflow_dispatch:
    inputs:
      release-version:
        description: "Version to release"
        required: true
        type: string
        default: "0.0.0"

env:
  RUST_TARGET_PATH: pact-reference/rust/target
  BINARIES_PATH: Resources
  REPO_OWNER: 'surpher'
  REPO_NAME: 'PactSwiftMockServer'

concurrency:
  group: build-ffi-binaries-${{ github.ref }}
  cancel-in-progress: true

jobs:
  shared-inputs:
    name: "🧑‍🤝‍🧑  Shared env vars"
    runs-on: ubuntu-latest
    outputs:
      repo-owner: ${{ env.REPO_OWNER }}
      repo-name: ${{ env.REPO_NAME }}
      release-version: ${{ inputs.release-version }}
    steps:
      - run: echo "Just a workaround for passing envs to other jobs... ¯\_(ツ)_/¯"

  build-ffi:
    name: "🏗️  Build FFI"
    needs: [shared-inputs]
    uses: ./.github/workflows/job_build_ffi.yml
    with:
      repo-owner: ${{ needs.sharedInputs.outputs.repo-owner }}
      repo-name: ${{ needs.sharedInputs.outputs.repo-name }}

  build-xcframework:
    name: "🧳  Build XCFramework"
    needs: [shared-inputs, build-ffi]
    uses: ./.github/workflows/job_build_xcframework.yml
    with:
      repo-owner: ${{ needs.sharedInputs.outputs.repo-owner }}
      repo-name: ${{ needs.sharedInputs.outputs.repo-name }}
      release-version: ${{ inputs.release-version }}

  open-pull-request:
    needs: [build-xcframework]
    name: "📥  Open Pull Request"
    uses: ./.github/workflows/job_open_pr.yml
    with:
      release-version: ${{ inputs.release-version }}
    secrets:
      PR_PAT: ${{ secrets.PR_PAT }}
    permissions:
      id-token: write

  create-draft-release:
    needs: [open-pull-request]
    name: "🚀  Create a release"
    uses: ./.github/workflows/job_release.yml
    with:
      release-version: ${{ inputs.release-version }}
