name: "Upgrade"

on:
  workflow_dispatch:
    inputs:
      release-version:
        description: "Version to release"
        required: true
        type: string
        default: "v0.0.0"
  push:
    branches-ignore:
      - main

env:
  RUST_TARGET_PATH: pact-reference/rust/target
  BINARIES_PATH: Resources
  REPO_OWNER: 'surpher'
  REPO_NAME: 'PactSwiftMockServer'

concurrency:
  group: build-ffi-binaries-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sharedInputs:
    name: "🧑‍🤝‍🧑  Shared env vars"
    runs-on: ubuntu-latest
    outputs:
      repo-owner: ${{ env.REPO_OWNER }}
      repo-name: ${{ env.REPO_NAME }}
      release-version: ${{ inputs.release-version }}
    steps:
      - run: echo "Just a workaround for passing envs to other jobs... ¯\_(ツ)_/¯"

  buildFFI:
    name: "🏗️  Build FFI"
    needs: [sharedInputs]
    uses: ./.github/workflows/job_build_ffi.yml
    with:
      repo-owner: ${{ needs.sharedInputs.outputs.repo-owner }}
      repo-name: ${{ needs.sharedInputs.outputs.repo-name }}

  buildXCFramework:
    name: "📦  Build XCFramework"
    needs: [sharedInputs, buildFFI]
    uses: ./.github/workflows/job_build_xcframework.yml
    with:
      repo-owner: ${{ needs.sharedInputs.outputs.repo-owner }}
      repo-name: ${{ needs.sharedInputs.outputs.repo-name }}

  openPullRequest:
    needs: [sharedInputs, buildFFI, buildXCFramework]
    name: "🚀  Open Pull Request"
    uses: ./.github/workflows/job_open_pr.yml
    with:
      release-version: ${{ inputs.release-version }}
    secrets:
      PR_PAT: ${{ secrets.PR_PAT }}
    permissions:
      id-token: write
