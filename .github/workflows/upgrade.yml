name: "Upgrade XCFramework"

on:
  workflow_dispatch:
    inputs:
      commit-sha:
        description: "The commit SHA of PactSwiftMockServer to build the new XCFramework from."
        required: true
        type: string
      release-version:
        description: "Version to release."
        required: true
        type: string
        default: "0.0.0"

env:
  RUST_TARGET_PATH: pact-reference/rust/target
  BINARIES_PATH: Resources
  REPO_OWNER: 'surpher'
  REPO_NAME: 'PactSwiftMockServer'

concurrency:
  group: build-ffi-binaries-${{ github.ref }}
  cancel-in-progress: true

jobs:
  shared-inputs:
    name: "🧑‍🤝‍🧑  Shared env vars"
    runs-on: ubuntu-latest
    outputs:
      repo-owner: ${{ env.REPO_OWNER }}
      repo-name: ${{ env.REPO_NAME }}
      release-version: ${{ inputs.release-version }}
      commit-sha: ${{ inputs.commit-sha }}
    steps:
      - run: echo "Just a workaround for passing envs to other jobs... ¯\_(ツ)_/¯"

  build-ffi:
    name: "🏗️  Build FFI"
    needs: [shared-inputs]
    uses: ./.github/workflows/job_build_ffi.yml
    with:
      repo-owner: ${{ needs.shared-inputs.outputs.repo-owner }}
      repo-name: ${{ needs.shared-inputs.outputs.repo-name }}
      commit-sha: ${{ needs.shared-inputs.outputs.commit-sha }}

  build-xcframework:
    name: "🧳  Build XCFramework"
    needs: [shared-inputs, build-ffi]
    uses: ./.github/workflows/job_build_xcframework.yml
    with:
      repo-owner: ${{ needs.shared-inputs.outputs.repo-owner }}
      repo-name: ${{ needs.shared-inputs.outputs.repo-name }}
      commit-sha: ${{ needs.shared-inputs.outputs.commit-sha }}
      release-version: ${{ inputs.release-version }}

  open-pull-request:
    needs: [build-xcframework]
    name: "📥  Open Pull Request"
    uses: ./.github/workflows/job_open_pr.yml
    with:
      release-version: ${{ inputs.release-version }}
    secrets:
      PR_PAT: ${{ secrets.PR_PAT }}
    permissions:
      id-token: write
